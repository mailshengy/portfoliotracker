<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Portfolio Overview | Live Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
        --bg: #f5f4f1;
        --accent: #bfa27a;
        --accent-dark: #9b825f;
        --text: #222222;
        --muted: #6e6e6e;
        --card: #ffffff;
        --positive: #2d5e38;
        --positive-bg: #e6f0ea;
        --negative: #a63434;
        --negative-bg: #fff0f0;
        --cpf-green: #9AB39E;
        --header-height: 70px;
      }
      * { box-sizing: border-box; margin: 0; padding: 0; }
      body { background: var(--bg); color: var(--text); line-height: 1.6; overflow-x: hidden; }
      body.nav-open { overflow: hidden; }
      a { text-decoration: none; color: inherit; transition: color 0.2s; }
      a:hover { color: var(--accent-dark); }

      /* --- HEADER & NAV --- */
      header { position: sticky; top: 0; z-index: 100; background: rgba(245, 244, 241, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0, 0, 0, 0.04); height: var(--header-height); }
      .nav { max-width: 1100px; margin: 0 auto; padding: 0 20px; height: 100%; display: flex; align-items: center; justify-content: space-between; }
      .logo { font-size: 1.1rem; letter-spacing: 0.15em; text-transform: uppercase; font-weight: 700; display: flex; align-items: center; z-index: 102; }
      .logo span { padding: 3px 8px; border-radius: 999px; border: 1px solid var(--accent); font-size: 0.65rem; margin-left: 10px; color: var(--accent-dark); white-space: nowrap; }
      .nav-links { display: flex; gap: 25px; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.12em; font-weight: 500; }

      /* Hamburger Menu */
      .hamburger { display: none; cursor: pointer; z-index: 102; width: 30px; height: 20px; position: relative; background: none; border: none; }
      .hamburger span { display: block; width: 100%; height: 2px; background-color: var(--text); position: absolute; transition: all 0.3s ease; }
      .hamburger span:nth-child(1) { top: 0; }
      .hamburger span:nth-child(2) { top: 9px; }
      .hamburger span:nth-child(3) { top: 18px; }
      .hamburger.active span:nth-child(1) { transform: rotate(45deg); top: 9px; }
      .hamburger.active span:nth-child(2) { opacity: 0; }
      .hamburger.active span:nth-child(3) { transform: rotate(-45deg); top: 9px; }
      .mobile-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: rgba(0,0,0,0.5); z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; backdrop-filter: blur(2px); }
      .mobile-overlay.active { opacity: 1; pointer-events: all; }

      /* --- MAIN LAYOUT --- */
      main { max-width: 1100px; margin: 0 auto; padding: 24px 20px 60px; }
      section { margin-top: 40px; }
      section h2 { font-size: 1rem; text-transform: uppercase; letter-spacing: 0.18em; margin-bottom: 4px; border-left: 3px solid var(--accent); padding-left: 10px; }
      .section-intro { font-size: 0.9rem; color: var(--muted); max-width: 600px; margin-bottom: 20px; margin-left: 13px; }

      /* --- HERO --- */
      .hero { display: grid; grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.8fr); gap: 40px; align-items: flex-start; padding: 28px 0 10px; }
      .hero-text h1 { font-size: clamp(1.8rem, 4vw, 2.8rem); letter-spacing: 0.04em; text-transform: uppercase; margin-bottom: 8px; line-height: 1.1; }
      .total-wealth { font-size: clamp(2rem, 5vw, 2.4rem); font-weight: 700; color: var(--accent-dark); margin-bottom: 10px; display: block; }
      .exchange-rate { font-size: 0.75rem; color: var(--muted); background: #e9e8e5; padding: 4px 8px; border-radius: 4px; display: inline-block; margin-bottom: 20px; }
      .status-dot { height: 8px; width: 8px; background-color: #ccc; border-radius: 50%; display: inline-block; margin-right: 5px; }
      .status-dot.live { background-color: var(--positive); box-shadow: 0 0 4px var(--positive); }
      .chart-container { background: #fff; padding: 20px; border-radius: 18px; box-shadow: 0 10px 30px rgba(185, 162, 138, 0.1); position: relative; height: 350px; width: 100%; }
      canvas { max-width: 100%; max-height: 100%; }

      /* --- GROWTH STATS --- */
      .growth-stats-row { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
      .stat-card { background: #fff; padding: 12px 18px; border-radius: 10px; border: 1px solid rgba(0,0,0,0.06); min-width: 140px; display: flex; flex-direction: column; }
      .stat-card .label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 4px; }
      .stat-card .value { font-size: 1.2rem; font-weight: 700; color: var(--accent-dark); }
      .stat-card .sub { font-size: 0.7rem; color: var(--muted); font-weight: 500; }

      /* --- CARDS --- */
      .grid { display: grid; gap: 16px; }
      .card { background: var(--card); padding: 18px; border-radius: 14px; border: 1px solid rgba(0, 0, 0, 0.05); display: flex; flex-direction: column; justify-content: space-between; transition: transform 0.2s ease, box-shadow 0.2s ease; }
      .card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
      .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
      .card-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.16em; color: var(--muted); }
      
      .yield-pill { background: var(--positive-bg); color: var(--positive); font-size: 0.7rem; padding: 3px 8px; border-radius: 4px; font-weight: 600; letter-spacing: 0.05em; }
      .yield-pill.negative { background: var(--negative-bg); color: var(--negative); }

      .card-title { font-size: 1.1rem; font-weight: 600; color: var(--text); }
      .card-ticker { font-size: 0.8rem; color: var(--accent-dark); font-family: monospace; margin-bottom: 12px; }
      .data-row { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 6px; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
      .data-row:last-child { border-bottom: none; }
      .data-label { color: var(--muted); }
      .data-val { font-weight: 500; }
      
      /* Special Card Styles */
      .highlight-card { border: 1px solid var(--accent); background: linear-gradient(145deg, #ffffff 0%, #fcfbf9 100%); }
      .cpf-card { border-left: 6px solid var(--cpf-green); }

      /* Dual Currency Styling */
      .val-group { text-align: right; line-height: 1.2; }
      .val-main { font-weight: 600; display: block; }
      .val-sub { font-size: 0.7rem; color: var(--muted); display: block; font-weight: 400; }

      /* --- RESPONSIVENESS --- */
      @media (min-width: 769px) {
        .grid-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
      }
      @media (max-width: 768px) {
        .hamburger { display: block; }
        .nav-links { position: fixed; top: 0; right: 0; height: 100vh; width: 75%; max-width: 300px; background: #fff; flex-direction: column; align-items: center; justify-content: center; gap: 40px; box-shadow: -5px 0 20px rgba(0,0,0,0.1); transform: translateX(100%); transition: transform 0.3s ease-in-out; z-index: 101; font-size: 1.2rem; }
        .nav-links.active { transform: translateX(0); }
        .hero { grid-template-columns: 1fr; gap: 20px; }
        .chart-container { order: -1; height: 320px; }
        .grid-3 { grid-template-columns: 1fr; }
        main { padding: 20px 15px 50px; }
      }
    </style>
  </head>
  <body>
    <div class="mobile-overlay" id="mobileOverlay" onclick="toggleMobileMenu()"></div>

    <header>
      <nav class="nav">
        <div class="logo">PORTFOLIO Live Dashboard <span>JSC</span></div>
        <button class="hamburger" id="hamburgerBtn" onclick="toggleMobileMenu()" aria-label="Toggle Menu">
          <span></span><span></span><span></span>
        </button>
        <div class="nav-links" id="navLinks">
          <a href="#summary" onclick="toggleMobileMenu()">Summary</a>
          <a href="#growth" onclick="toggleMobileMenu()">Growth</a>
          <a href="#equities" onclick="toggleMobileMenu()">Equities</a>
          <a href="#cash" onclick="toggleMobileMenu()">Cash</a>
        </div>
      </nav>
    </header>

    <main>
      <section class="hero" id="summary">
        <div class="hero-text">
          <h1>Portfolio Tracking</h1>
          <span class="total-wealth" id="total-wealth-display">Loading...</span>
          <span class="exchange-rate">
            <span class="status-dot" id="status-dot"></span>
            <span id="fx-rate-display">Synced with Google Sheets</span>
          </span>
          <p>Real-time End of Day Valuation of Global Portfolio and Holdings.</p>
        </div>
        <div class="chart-container">
          <canvas id="portfolioChart"></canvas>
        </div>
      </section>

      <section id="growth">
        <h2>Portfolio Growth</h2>
        <p class="section-intro">Overall performance since Inception. "Initial Cost" for Cash/CPF is assumed equal to current value.</p>
        
        <div class="growth-stats-row">
            <div class="stat-card">
                <span class="label">Total Abs. Return</span>
                <span class="value" id="overall-abs-return">--%</span>
                <span class="sub">Unrealized P&L</span>
            </div>
            <div class="stat-card">
                <span class="label">Annual CAGR</span>
                <span class="value" id="overall-cagr">--%</span>
                <span class="sub">Compounded Yearly</span>
            </div>
        </div>

        <div class="chart-container" style="height: 300px;">
          <canvas id="growthChart"></canvas>
        </div>
      </section>

      <section id="equities">
        <h2>Equity Holdings</h2>
        <p class="section-intro">
          <strong>(CAGR)</strong> = Compound Annual Growth Rate. <br>
          <strong>Abs. Return</strong> = Total percentage gain/loss on initial capital.
        </p>
        
        <div class="grid grid-3" id="equity-grid">
          </div>
      </section>

      <section id="cash">
        <h2>Cash & Government Securities</h2>
        <p class="section-intro">Liquidity, Savings and CPF.</p>
        
        <div class="grid grid-3" id="cash-grid">
           </div>
      </section>

    </main>

    <script>
      // *** 1. CONFIGURATION ***
      const DATA_URL = "https://script.google.com/macros/s/AKfycbw1Wi6MNWBGBtVR0QhgwJ3AY4iXIHS5fdGbQf5GrVvIvA1ARSXmi01JpS_UuA_Vjuzy4Q/exec"; 
      
      // Formatting Utilities
      const fmt = (num) => new Intl.NumberFormat('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(num);
      const fmtPrice = (num) => new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);
      const fmtSGD = (num) => new Intl.NumberFormat('en-SG', { style: 'currency', currency: 'SGD', maximumFractionDigits: 0 }).format(num);

      // Mobile Menu Logic
      function toggleMobileMenu() {
        document.getElementById('navLinks').classList.toggle('active');
        document.getElementById('mobileOverlay').classList.toggle('active');
        document.getElementById('hamburgerBtn').classList.toggle('active');
        document.body.classList.toggle('nav-open');
      }

      // *** 2. MAIN LOGIC ***
      async function fetchData() {
        try {
          const response = await fetch(DATA_URL);
          const data = await response.json();
          renderDashboard(data);
        } catch (error) {
          console.error("Error fetching sheet data:", error);
          document.getElementById('total-wealth-display').innerText = "Connection Error";
        }
      }

      function renderDashboard(data) {
        const equityContainer = document.getElementById('equity-grid');
        const cashContainer = document.getElementById('cash-grid');
        
        equityContainer.innerHTML = '';
        cashContainer.innerHTML = '';

        let totalValueSGD = 0;
        let totalCostSGD = 0;
        let chartLabels = [];
        let chartData = [];
        const chartColors = ['#9b825f', '#bfa27a', '#cab9a1', '#8a6b46', '#d5c6b3', '#e6dace', '#5c5c5c', '#9e9e9e', '#9AB39E'];

        data.forEach(item => {
          // 1. Data Parsing
          const valNative = parseFloat(item.valNative);
          const valSGD = parseFloat(item.valSGD);
          const price = parseFloat(item.price);
          const costNative = parseFloat(item.totalCost);

          // 2. Global Sums
          totalValueSGD += valSGD;
          
          // Estimate Initial Cost in SGD for overall calc
          // If USD, we use implied FX from the current value to estimate cost basis in SGD
          // (Simplified logic: CostSGD = CostNative * (ValSGD / ValNative))
          let impliedFx = (valNative > 0) ? (valSGD / valNative) : 1;
          let costSGD = costNative * impliedFx;
          totalCostSGD += costSGD;

          // 3. Chart Data
          chartLabels.push(item.title);
          chartData.push(valSGD);

          // 4. Determine Card Types & Styling
          const isEquity = item.type.toLowerCase() === 'equity';
          const isUSD = item.currency === 'USD';
          const isPos = !item.absReturn.includes('-');
          const highlightClass = item.label.includes("GROWTH") ? "highlight-card" : "";
          const cpfClass = item.tickerDisplay === 'CPF' ? 'cpf-card' : "";

          // 5. Format Strings
          const currencyPrefix = isUSD ? "US$" : "$";
          const priceStr = `${currencyPrefix}${fmtPrice(price)}`;
          const valMainStr = currencyPrefix + fmt(valNative);
          const valSubStr = isUSD ? `â‰ˆ ${fmtSGD(valSGD)}` : ""; 
          const costStr = currencyPrefix + fmt(costNative);

          // 6. Build HTML
          const cardHTML = `
            <article class="card ${highlightClass} ${cpfClass}">
              <div class="card-header">
                <span class="card-label">${item.label}</span>
                <span class="yield-pill ${isPos ? '' : 'negative'}">${item.cagr}</span>
              </div>
              <div class="card-title">${item.title}</div>
              ${isEquity 
                ? `<div class="card-ticker">${item.tickerDisplay}</div>` 
                : `<div class="card-ticker" style="opacity:0">.</div>`}
              
              <div class="data-row">
                <span class="data-label">${isEquity ? 'Holdings' : 'Status'}</span>
                <span class="data-val">${isEquity ? item.qty + ' Units' : 'Active'}</span>
              </div>
              <div class="data-row">
                <span class="data-label">${isEquity ? 'Market Price' : 'Balance'}</span>
                <span class="data-val">${priceStr}</span>
              </div>
              <div class="data-row" style="align-items:flex-start">
                <span class="data-label">Total Value</span>
                <div class="val-group">
                  <span class="val-main">${valMainStr}</span>
                  ${valSubStr ? `<span class="val-sub">${valSubStr}</span>` : ''}
                </div>
              </div>
              
              <div class="data-row">
                <span class="data-label">${isEquity ? 'Initial Cost' : 'Initial Deposit'}</span>
                <span class="data-val" style="color:var(--muted)">${costStr}</span>
              </div>

              <div class="data-row">
                <span class="data-label">Abs. Return</span>
                <span class="data-val" style="color:${isPos ? 'var(--positive)' : 'var(--negative)'}">
                   ${item.absReturn.includes('+') || item.absReturn.includes('-') ? '' : '+'}${item.absReturn}
                </span>
              </div>
            </article>
          `;

          if (isEquity) { equityContainer.innerHTML += cardHTML; } 
          else { cashContainer.innerHTML += cardHTML; }
        });

        // Update Header & Growth Stats
        document.getElementById('total-wealth-display').textContent = fmtSGD(totalValueSGD);
        document.getElementById('status-dot').classList.add('live');
        
        // Calculate Overall Portfolio Performance
        const totalAbsReturn = ((totalValueSGD - totalCostSGD) / totalCostSGD) * 100;
        // Years held assumption (approx 3.2 years since Nov 2021)
        const yearsHeld = 3.2; 
        const totalCagr = (Math.pow((totalValueSGD / totalCostSGD), (1 / yearsHeld)) - 1) * 100;

        const absElem = document.getElementById('overall-abs-return');
        const cagrElem = document.getElementById('overall-cagr');
        
        absElem.textContent = (totalAbsReturn > 0 ? '+' : '') + totalAbsReturn.toFixed(1) + '%';
        absElem.style.color = totalAbsReturn >= 0 ? 'var(--positive)' : 'var(--negative)';
        
        cagrElem.textContent = (totalCagr > 0 ? '+' : '') + totalCagr.toFixed(1) + '%';
        cagrElem.style.color = totalCagr >= 0 ? 'var(--positive)' : 'var(--negative)';

        // Render Charts
        renderCharts(chartLabels, chartData, chartColors);
      }

      // *** 3. CHARTS ***
      let myChart = null;
      let lineChart = null;

     function renderCharts(labels, data, colors) {
        // Doughnut Chart (Live Data)
        const ctx = document.getElementById('portfolioChart').getContext('2d');
        
        if (myChart) myChart.destroy();
        
        myChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: labels,
            datasets: [{
              data: data,
              backgroundColor: colors,
              borderWidth: 0,
              hoverOffset: 10
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
              legend: { 
                position: window.innerWidth < 768 ? 'bottom' : 'right', 
                labels: { usePointStyle: true, font: { family: 'system-ui' }, padding: 15 } 
              },
              // --- NEW TOOLTIP CONFIGURATION STARTS HERE ---
              tooltip: {
                callbacks: {
                  label: function(context) {
                    // 1. Get the Label
                    let label = context.label || '';
                    if (label) {
                        label += ': ';
                    }
                    
                    // 2. Get the current Value
                    const value = context.raw;
                    
                    // 3. Calculate the Total of the dataset
                    const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
                    
                    // 4. Calculate Percentage
                    const percentage = ((value / total) * 100).toFixed(1) + '%';
                    
                    // 5. Return the formatted string: "Title: $1,000 (15.5%)"
                    return label + fmtSGD(value) + ' (' + percentage + ')';
                  }
                }
              }
              // --- NEW TOOLTIP CONFIGURATION ENDS HERE ---
            }
          }
        });

        // Line Chart (Static Demo Data)
        const ctxLine = document.getElementById('growthChart').getContext('2d');
        if (lineChart) lineChart.destroy();
        const histDates = ['Jan 22', 'Jul 22', 'Jan 23', 'Jul 23', 'Jan 24', 'Jul 24', 'Jan 25'];
        const histData = [280000, 265000, 290000, 310000, 335000, 360000, 410000]; 
        
        lineChart = new Chart(ctxLine, {
            type: 'line',
            data: {
                labels: histDates,
                datasets: [{
                    label: 'Portfolio Value (SGD)',
                    data: histData,
                    borderColor: '#bfa27a',
                    backgroundColor: 'rgba(191, 162, 122, 0.1)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 3,
                    pointBackgroundColor: '#9b825f'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: false, grid: { color: 'rgba(0,0,0,0.05)' } },
                    x: { grid: { display: false } }
                },
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                             label: function(context) {
                                return context.dataset.label + ': ' + fmtSGD(context.raw);
                             }
                        }
                    }
                }
            }
        });
      }

      // Init
      fetchData();
      window.addEventListener('resize', () => { fetchData(); }); // Re-render charts on resize
    </script>
  </body>
</html>
